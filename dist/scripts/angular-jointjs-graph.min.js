"use strict";angular.module("angular-jointjs-graph",["ngResource","angular-jointjs-graph/templates"]),angular.module("angular-jointjs-graph/templates",[]).run(["$templateCache",function(a){a.put("angular-joints-graph/templates/graph",'<div class="organogram">\n<section class="chartContainer">\n<div class="chartArea" droppable="handleDrop(entityAttributes, dropPoint)"></div>\n<div ng-transclude></div>\n</section>\n</div>'),a.put("angular-joints-graph/templates/graphNode",'<g class="rotatable">\n<g class="scalable">\n<rect/>\n</g>\n<text class="name"/>\n<text class="country"/>\n<g transform="translate(110, 3)">\n<text class="icon beneficiary" style="font-family:ce-icons;fill:#E5EAEF;"/>\n<text class="icon company" style="font-family:ce-icons;fill:#E5EAEF;"/>\n</g>\n<a class="connection-port" xlink:href="">\n<path d="M0,0 30,0 30,38 0,38" style="fill:white;fill-opacity:0.0;"/>\n<circle class="outer" cx="15" cy="19" r="6"/>\n<circle class="inner" cx="15" cy="19" r="2.5"/>\n</a>\n<a class="remove-element" xlink:href="">\n<path d="M220,0 260,0 260,38 220,38" style="fill:white;fill-opacity:0.0;"/>\n<path class="cross" transform="translate(235, 15)" opacity="0.4" d="M0,0 L10,10 M10,0 L0,10"/>\n</a>\n</g>'),a.put("angular-joints-graph/templates/graphSidePanelTools",'<div class="graph-tools">\n<div class="basic">\n<div class="intro">Drag to create new</div>\n<div class="fabric"></div>\n</div>\n<a href="" class="switch" ng-click="toggleExtended()">\nor choose from existing\n<i class="ce-icon-caret-down" ng-class="showExtended ? \'rotated\' : \'\'"></i>\n</a>\n<div class="extended" ng-show="showExtended">\n<ul class="listing"></ul>\n</div>\n</div>'),a.put("angular-joints-graph/templates/graphSidePanelDetails","<div ng-transclude></div>"),a.put("angular-joints-graph/templates/graphNewEntity",'<div class="instance-template" draggable></div>'),a.put("angular-joints-graph/templates/graphExistingEntities",'<li ng-repeat="entity in existingEntities" ng-hide="entity.show == false" draggable graph-existing-entity></li>')}]),angular.module("angular-jointjs-graph").directive("draggable",["$window",function(a){return function(b,c){var d=c[0];d.draggable=!0,d.addEventListener("dragstart",function(b){b.dataTransfer.effectAllowed="copy",b.dataTransfer.setData("entity-attributes",JSON.stringify(d.dataset)),this.classList.add("drag");var c=b.clientX-b.target.getBoundingClientRect().left,e=b.clientY-b.target.getBoundingClientRect().top,f=a.g.point(c,e);b.dataTransfer.setData("pointer-offset",f)}),d.addEventListener("dragend",function(){this.classList.remove("drag")})}}]),angular.module("angular-jointjs-graph").directive("droppable",["$window","$parse",function(a,b){return{link:function(c,d,e){if(!e.droppable)throw new Error("Directive requires a function call expression as argument");var f=b(e.droppable),g=d[0];g.addEventListener("dragover",function(a){a.preventDefault(),a.dataTransfer.dropEffect="copy"}),g.addEventListener("drop",function(b){b.stopPropagation();var e=a.g.point(b.dataTransfer.getData("pointer-offset")),g=d[0].getBoundingClientRect(),h=Math.floor(b.clientX-g.left-e.x),i=Math.floor(b.clientY-g.top-e.y),j=a.g.point(h,i),k=JSON.parse(b.dataTransfer.getData("entity-attributes"));f(c,{entityAttributes:k,dropPoint:j})})}}}]),angular.module("angular-jointjs-graph").directive("graph",["JointGraph","JointChartNode","JointElementView","JointNodeModel","JointPaper","JointNodeParams","FactoryMap","$q",function(a,b,c,d,e,f,g,h){return{restrict:"E",templateUrl:"angular-joints-graph/templates/graph",transclude:!0,controller:["$scope","$element","$attrs",function(i,j,k){function l(a){var b={};return _.each(w.entityModelProperties(),function(c){b[c]=a[c]}),b}function m(){var b=a.getCell(i.selection.selectedCellId),c=l(i.selection.selectedResource);b&&b.attr(f.get(c).attrs)}function n(a){if(i.revertEntity(),a){var b={};b[v]=a.backendModelId;var c=a.isChartNode?_.findWhere(i.existingEntities,b):_.findWhere(i.existingConnections,b);i.selection={isChartNode:a.isChartNode,selectedResource:c,selectedCellId:a.selectedCellId,masterResource:angular.copy(c)}}else i.selection=null}function o(){i.$apply(function(){i.clearCellSelectionAndRevert()})}function p(b){var c=a.getCell(b);i.$apply(function(){c.createResource().then(function(a){i.existingConnections.push(a),i.saveGraph()},function(a){i.$emit("applicationError",{errData:a}),c.remove({skipCallbacks:!0})})})}function q(a,b){a.preventDefault(),i.$apply(function(){var a={},c=b.get("backendModelParams")[v];a[v]=c;var d=_.findWhere(i.existingEntities,a),e=i.selection?i.selection.selectedResource:null;d&&d.$remove().then(function(){d===e&&i.clearCellSelection(),d.show=!0,delete i.entityJointModelMap[c],i.saveGraph()},function(a){i.$emit("applicationError",{errData:a})})})}function r(a,b,c){if(c&&c.skipCallbacks);else{var d,e=a.get("backendModelParams"),f={};f[v]=e[v],d=_.findWhere(i.existingConnections,f),d&&d.$remove().then(function(){_.remove(i.existingConnections,f),i.saveGraph()},function(a){i.$emit("applicationError",{errData:a})})}}function s(a){var b=h.defer(),c=a.get("backendModelParams")[v];if("undefined"===c)a.createResource().then(function(c){c.show=!1,i.entityJointModelMap[c[v]]=a.id,i.existingEntities.unshift(c),b.resolve({newNode:!0})},function(a){b.reject(a)});else{var d={};d[v]=c,i.entityJointModelMap[c]=a.id,_.findWhere(i.existingEntities,d).show=!1,b.resolve({newNode:!1})}return b.promise}function t(a){var b=e.getPaper().findViewByModel(a);e.clearSelection(),n(e.selectCell(b))}g.register(k.configFactory,"JointGraphConfig");var u=g.get("JointGraphConfig"),v=u.modelIdKey||"id",w=this;g.register(u.linkFactory,"LinkFactory"),_.each(u.entityFactories,function(a,b){g.register(a,b)}),this.entityModelProperties=function(){var a=u.entityModelProperties;return a?(a.push(v),a):[v]},i.$on("graphResources",function(b,f){var g=f.graph,k=f.entities,l=f.entityRelations,m=new g,s=h.defer();m.$get().then(function(a){i.graph=a,k.query(function(a){i.existingEntities=a,l.query(function(a){i.existingConnections=a,s.resolve()},function(a){s.reject(a)})},function(a){s.reject(a)})},function(a){s.reject(a)}),s.promise.then(function(){d.init(i),c.init(j.find(".chartContainer")),e.init(j.find(".chartArea")),e.onSelectionChange(function(a){n(a),i.$digest()}),e.onCellPositionChange(function(){i.saveGraph()}),a.on("add",function(a){a.get("isChartNode")?(a.on("createLinkStart",o),a.on("createLinkEnd",p),a.on("nodeRemoved",q)):a.on("remove",r)});var b=JSON.parse(i.graph.content)||{};i.entityJointModelMap={},b.cells&&(_.each(b.cells,function(a){if(a.isChartNode){var b={},c=a.backendModelParams[v];b[v]=c,i.entityJointModelMap[c]=a.id,_.findWhere(i.existingEntities,b).show=!1}}),a.addCells(b.cells))},function(a){i.$emit("applicationError",{errData:a})})}),_.each(this.entityModelProperties(),function(a){i.$watch("selection.selectedResource."+a,function(a,b){b&&i.selection&&m()})}),i.clearCellSelectionAndRevert=function(){e.clearSelection(),n(null)},i.clearCellSelection=function(){e.clearSelection(),i.selection=null},i.revertEntity=function(){i.selection&&(angular.copy(i.selection.masterResource,i.selection.selectedResource),m())},i.syncEntity=function(){i.selection&&angular.copy(i.selection.selectedResource,i.selection.masterResource)},i.selectEntity=function(a){n({backendModelId:a[v],selectedCellId:i.entityJointModelMap[a[v]],isChartNode:!0})},i.saveGraph=function(){setTimeout(function(){i.graph.content=JSON.stringify(a.toJSON()),i.graph.$update()["catch"](function(a){i.$emit("applicationError",{errData:a})})},0)},i.handleDrop=function(c,d){i.$apply(function(){var e=b.create(c,d);a.addCell(e),s(e).then(function(a){a.newNode&&t(e),i.saveGraph()},function(a){i.$emit("applicationError",{errData:a}),e.remove()})})}}]}}]),angular.module("angular-jointjs-graph").directive("graphExistingEntities",[function(){return{require:"^graph",restrict:"E",templateUrl:"angular-joints-graph/templates/graphExistingEntities",transclude:!0,controller:["$attrs","$transclude",function(a,b){this.transclude=b}]}}]),angular.module("angular-jointjs-graph").directive("graphExistingEntity",[function(){return{require:["^graph","^graphExistingEntities"],restrict:"A",link:function(a,b,c,d){var e=d[0].entityModelProperties(),f=b[0];e&&_.each(e,function(b){f.dataset[b]=a.entity[b],a.$watch("entity."+b,function(a){f.dataset[b]=a})}),d[1].transclude(a,function(a){b.append(a)})}}}]),angular.module("angular-jointjs-graph").directive("graphNewEntity",["$compile",function(a){return{require:"^graph",restrict:"E",templateUrl:"angular-joints-graph/templates/graphNewEntity",transclude:!0,link:function(b,c,d,e,f){var g=c.find(".instance-template")[0],h=e.entityModelProperties();return h&&_.each(h,function(a){g.dataset[a]=void 0}),g.dataset.entityIdentifier=d.entityIdentifier,f(b,function(a){c.children().first().append(a)}),a(c.contents())(b)}}}]),angular.module("angular-jointjs-graph").directive("graphSidePanelDetails",[function(){return{require:"^graph",scope:!0,restrict:"E",templateUrl:"angular-joints-graph/templates/graphSidePanelDetails",transclude:!0}}]),angular.module("angular-jointjs-graph").directive("graphSidePanelTools",[function(){return{require:"^graph",restrict:"E",templateUrl:"angular-joints-graph/templates/graphSidePanelTools",transclude:!0,controller:["$scope",function(a){a.showExtended=!1,a.toggleExtended=function(){a.showExtended=!a.showExtended}}],compile:function(){return{post:function(a,b,c,d,e){e(a,function(a){b.find("div.fabric").append(a.siblings("graph-new-entity").addBack()),b.find("ul.listing").append(a.siblings("graph-existing-entities"))})}}}}}]),angular.module("angular-jointjs-graph").factory("FactoryMap",["$injector",function(a){var b={};return{register:function(c,d){if(!a.has(c))throw new Error("Factory "+c+" is not registered with any loaded module.");b[d||c]=c},get:function(c){return a.get(b[c],null)}}}]),angular.module("angular-jointjs-graph").factory("JointChartLink",["$injector","$q","JointLinkDefaults","JointResourceModel","FactoryMap",function(a,b,c,d,e){function f(){var a=e.get("JointGraphConfig"),b=a.modelIdKey,c=a.linkModelProperties;return c?(c.push(b),c):[b]}return{create:function(a){var b=d.forLink(e.get("LinkFactory")),g={},h=f();_.each(h,function(a){g[a]="undefined"});var i={backendModelParams:g,attrs:c.newLinkAttributes,isChartNode:!1};return b.create(angular.extend(i,a))}}}]),angular.module("angular-jointjs-graph").factory("JointChartNode",["$injector","JointResourceModel","FactoryMap",function(a,b,c){function d(a){return a.entityIdentifier?b.forNewEntity(c.get(a.entityIdentifier)):b.forExistingEntity()}return{create:function(b,c){var e=d(b),f={position:{x:c.x,y:c.y},backendModelParams:b,options:{interactive:!0},isChartNode:!0};if(a.has("JointNodeParams")){var g=a.get("JointNodeParams");angular.extend(f,g.get(b))}return e.create(f)}}}]),angular.module("angular-jointjs-graph").factory("JointElementView",["$window","JointChartLink",function(a,b){function c(c){a.joint.shapes.html.ElementView=a.joint.dia.ElementView.extend({link:null,canUpdateLink:!1,initialize:function(){a.joint.dia.ElementView.prototype.initialize.apply(this,arguments)},render:function(){a.joint.dia.ElementView.prototype.render.apply(this,arguments),this.findBySelector(".connection-port").on("mousedown",this.createLink.bind(this));var b=this.findBySelector(".remove-element"),c=this;return b.on("mousedown",function(a){a.stopPropagation()}),b.on("click",function(a){_.each(c.paper.model.getConnectedLinks(c.model),function(a){a.remove({skipCallbacks:!0})}),c.model.remove(),c.model.trigger("nodeRemoved",a,c.model)}),b.on("mouseenter",function(){$(this).find(".cross").get(0).setAttribute("opacity",1)}),b.on("mouseleave",function(){$(this).find(".cross").get(0).setAttribute("opacity",.4)}),this.paper.$el.mousemove(this.onMouseMove.bind(this)),this.paper.$el.mouseup(this.onMouseUp.bind(this)),this},createLink:function(c){var d=this.paper.$el.offset(),e=$(c.target).offset(),f=e.left-d.left,g=e.top-d.top;c.stopPropagation(),a.V(this.el).addClass("source-view"),this.model.trigger("createLinkStart"),this.link=b.create({source:{id:this.model.get("id")},target:a.g.point(f,g)}),this.paper.model.addCell(this.link),this.linkView=this.paper.findViewByModel(this.link),this.linkView.startArrowheadMove("target"),this.link.on("change:target",function(a){a.invalidTarget()||a.allowed()?(a.colorLinkAllowed(),a.removeLinkLabels(),a.removeForbiddenHighlight()):(a.colorLinkForbidden(),a.addLinkForbiddenLabel(),a.addForbiddenHighlight())}),this.canUpdateLink=!0},onMouseUp:function(b){this.linkView&&(this.link.addLinkMidpoint(),a.V(this.el).removeClass("source-view"),this.linkView.pointerup(b,b.clientX,b.clientY),this.link.colorLinkCreated(),this.link.removeForbiddenHighlight(),this.link.allowed()?this.model.trigger("createLinkEnd",this.link.id,this.link.get("target").id):this.link.remove({skipCallbacks:!0}),delete this.linkView,this.model.trigger("batch:stop")),this.canUpdateLink=!1,this.paper.$el.find(".component").css("z-index",1)},onMouseMove:function(b){if(this.link&&this.canUpdateLink&&!(b.clientX<=10)){this.linkView&&this.linkView.pointermove(b,b.clientX,b.clientY);var d=c[0].getBoundingClientRect();this.link.set("target",a.g.point(b.clientX-d.left,b.clientY-d.top))}}})}return{init:function(a){c(a)}}}]),angular.module("angular-jointjs-graph").factory("JointGraph",["$window",function(a){return new a.joint.dia.Graph}]),angular.module("angular-jointjs-graph").factory("JointLinkDefaults",["$injector",function(a){var b={linkConnectionColorAllowed:"#66AC3F",linkMarkerColorAllowed:"#66AC3F",linkConnectionColorForbidden:"#C4434B",linkMarkerColorForbidden:"#C4434B",linkConnectionColorCreated:"#AAAAAA",linkMarkerColorCreated:"#AAAAAA",linkConnectionWidthCreated:1,linkForbiddenCaption:"  Cannot create link to beneficiary  "},c={newLinkAttributes:{".connection":{stroke:b.linkConnectionColorCreated,"stroke-width":3},".marker-target":{fill:b.linkMarkerColorCreated,"stroke-width":0,d:"M 10 0 L 0 5 L 10 10 z"},".marker-source":{display:"none"},".marker-vertex-remove-area":{display:"none"},".marker-vertex-remove":{display:"none"}},linkForbiddenLabel:{position:.5,attrs:{rect:{fill:b.linkConnectionColorForbidden,stroke:b.linkConnectionColorForbidden,"stroke-width":"5"},text:{fill:"white",text:b.linkForbiddenCaption,"font-weight":"normal"}}}};return a.has("JointLinkParams")&&angular.extend(c,b,a.get("JointLinkParams")),c}]),angular.module("angular-jointjs-graph").factory("JointLinkModel",["$window","JointPaper","JointLinkDefaults",function(a,b,c){function d(c){var d,e=b.getPaper(),f=e.findViewByModel(c),g=f.sourceView;if(f.targetView)d=f.targetView;else{var h=c.get("target");d=e.findViewsFromPoint(a.g.point(h.x,h.y))[0]}return[g,d]}var e=a.joint.dia.Link.extend();return e.prototype.colorLinkAllowed=function(){this.attr(".connection/stroke",c.linkConnectionColorAllowed),this.attr(".marker-target/fill",c.linkMarkerColorAllowed)},e.prototype.colorLinkForbidden=function(){this.attr(".connection/stroke",c.linkConnectionColorForbidden),this.attr(".marker-target/fill",c.linkMarkerColorForbidden)},e.prototype.colorLinkCreated=function(){this.attr(".connection/stroke-width",c.linkConnectionWidthCreated),this.attr(".connection/stroke",c.linkConnectionColorCreated),this.attr(".marker-target/fill",c.linkMarkerColorCreated)},e.prototype.addLinkForbiddenLabel=function(){this.set("labels",[c.linkForbiddenLabel])},e.prototype.removeLinkLabels=function(){this.unset("labels")},e.prototype.toggleForbiddenHighlight=function(b){_.each(d(this),function(c){if(c){var d=a.V(c.el),e=b?d.addClass:d.removeClass;e.call(d,"nolink")}})},e.prototype.addForbiddenHighlight=function(){this.toggleForbiddenHighlight(!0)},e.prototype.removeForbiddenHighlight=function(){this.toggleForbiddenHighlight(!1)},e.prototype.addLinkMidpoint=function(){var c=b.getPaper().findViewByModel(this),d=a.g.line(a.g.point(c.sourcePoint),a.g.point(c.targetPoint)).midpoint();this.set("vertices",[{x:d.x,y:d.y}]),this.attr(".marker-vertex/r","5")},e.prototype.allowed=function(){return c.canCreateLink?c.canCreateLink.apply(null,d(this)):!0},e.prototype.invalidTarget=function(){var a=d(this),b=!a[1],c=a[0]===a[1];return b||c},{getConstructor:function(){return e}}}]),angular.module("angular-jointjs-graph").factory("JointNodeModel",["$window","$compile","$templateCache",function(a,b,c){var d;return{init:function(e){d=a.joint.shapes.basic.Rect.extend({markup:b(c.get("angular-joints-graph/templates/graphNode"))(e)[0].outerHTML,defaults:a.joint.util.deepSupplement({type:"html.Element"},a.joint.shapes.basic.Rect.prototype.defaults)}),a.joint.shapes.html={Element:d}},getConstructor:function(){if(_.isUndefined(d))throw new Error("Factory has not been initialized yet, use init($scope)");return d}}}]),angular.module("angular-jointjs-graph").factory("JointPaper",["$window","JointGraph","FactoryMap",function(a,b,c){var d,e;return{init:function(c){d=new a.joint.dia.Paper({el:c[0],width:"100%",height:"100%",gridSize:1,model:b,interactive:{vertexAdd:!1},perpendicularLinks:!0})},getPaper:function(){return d},clearSelection:function(){if(e){var c=b.getCell(e);if(c){var f=d.findViewByModel(c);a.V(f.el).removeClass("selected")}e=null}},selectCell:function(b){a.V(b.el).addClass("selected"),e=b.model.get("id");var d=b.model.get("backendModelParams"),f=b.model.get("isChartNode")?!0:!1,g=c.get("JointGraphConfig").modelIdKey||"id",h=d[g];return{backendModelId:h,selectedCellId:e,isChartNode:f}},onSelectionChange:function(a){var b=this;d.on("blank:pointerdown",function(){b.clearSelection(),a(null)}),d.on("cell:pointerclick",function(c){b.clearSelection(),a(b.selectCell(c))})},onCellPositionChange:function(a){var b,c;d.on("cell:pointerdown",function(a,d,e){b=d,c=e}),d.on("cell:pointerup",function(d,e,f){if(b&&c){var g=Math.abs(b-e),h=Math.abs(c-f);(g>10||h>10)&&a(),b=null,c=null}})}}}]),angular.module("angular-jointjs-graph").factory("JointResourceModel",["JointNodeModel","JointLinkModel","$q",function(a,b,c){function d(a){function b(a){c.call(this,a)}var c=a.getConstructor();return b.prototype=Object.create(c.prototype),b.prototype.constructor=c,b}function e(a){return{create:function(b){return new a(b)}}}function f(a,b){if(_.isUndefined(b.resource))throw new Error("Entity and link factories must return an object declaring a resource field");var f=d(a);return f.prototype.createResource=function(){var a=c.defer(),d={},e=this;return _.isFunction(b.postDataFn)&&(d=b.postDataFn(this)),b.resource.save({},d,function(c){var d=e.get("backendModelParams");_.each(d,function(a,b){c.hasOwnProperty(b)&&(d[b]=c[b])}),_.isFunction(b.modelUpdateCallback)&&b.modelUpdateCallback(e,c),a.resolve(c)},function(b){a.reject(b)}),a.promise},new e(f)}return{forExistingEntity:function(){return new e(d(a))},forNewEntity:function(b){return f(a,b)},forLink:function(a){return f(b,a)}}}]);